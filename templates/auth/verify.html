<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Confirm Your Email</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <style>
    body { min-height: 100vh; background: #f5f7fb; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card { border:0; border-radius:1.25rem; box-shadow:0 10px 25px rgba(0,0,0,.06); }
    .code-input { width:48px; height:56px; text-align:center; font-size:1.25rem; border-radius:.75rem; margin:0 .25rem; }
    .code-row { display:flex; justify-content:center; }
    .muted { color:#6b7280; }
    .btn { border-radius:.75rem; }
  </style>
</head>
<body>
  <div class="container" style="max-width:560px;">
    <div class="text-center mb-4">
      <h4 class="mb-1">Confirm your email</h4>
      <p class="muted mb-0">We've sent a 6‑digit code to <strong id="displayEmail">{{ request.cookies.get('email') }}</strong></p>
    </div>

    <div class="card">
      <div class="card-body p-4 p-md-5">
        <form action="/do-verify-email" method="POST" id="verifyForm" novalidate>
          <input type="hidden" name="email" value="{{ request.cookies.get('email') }}">
          <div class="form-group text-center">
            <label class="d-block mb-2">Enter verification code</label>
            <div class="code-row mb-3">
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control code-input" name="d1" required>
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control code-input" name="d2" required>
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control code-input" name="d3" required>
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control code-input" name="d4" required>
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control code-input" name="d5" required>
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control code-input" name="d6" required>
            </div>
            <input type="hidden" name="code" id="fullCode">
            <div class="invalid-feedback d-block" id="codeError" style="display:none;">Please enter the 6‑digit code.</div>
          </div>

          <button type="submit" class="btn btn-primary btn-block">Verify</button>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
  <script>
    // Auto-advance between inputs; assemble full code on submit
    const inputs = Array.from(document.querySelectorAll('.code-input'));
    inputs.forEach((inp, idx) => {
      inp.addEventListener('input', e => {
        const v = e.target.value.replace(/\D/g, '').slice(0,1);
        e.target.value = v;
        if (v && idx < inputs.length - 1) inputs[idx+1].focus();
      });
      inp.addEventListener('keydown', e => {
        if (e.key === 'Backspace' && !e.target.value && idx > 0) inputs[idx-1].focus();
      });
      inp.addEventListener('paste', e => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'').slice(0,6);
        for (let i=0; i<6; i++) { inputs[i].value = text[i] || ''; }
        if (text.length === 6) document.getElementById('verifyForm').dispatchEvent(new Event('submit', {cancelable:true}));
      });
    });

    document.getElementById('verifyForm').addEventListener('submit', function(e){
      const code = inputs.map(i => i.value).join('');
      document.getElementById('fullCode').value = code;
      if (code.length !== 6) {
        document.getElementById('codeError').style.display = 'block';
        e.preventDefault();
        e.stopPropagation();
      }
    });

    // Resend countdown (60s)
    let remaining = 60;
    const timerEl = document.getElementById('timer');
    const resendBtn = document.getElementById('resendBtn');
    const tick = () => {
      remaining -= 1;
      timerEl.textContent = remaining;
      if (remaining <= 0) {
        resendBtn.removeAttribute('disabled');
        resendBtn.textContent = 'Resend code';
        clearInterval(intv);
      }
    };
    const intv = setInterval(tick, 1000);

    // If server injects email via query (?email=...) and templating is unavailable, try URL param fallback
    (function() {
      const params = new URLSearchParams(window.location.search);
      const emailParam = params.get('email');
      if (emailParam) {
        document.querySelectorAll('input[name="email"]').forEach(el => el.value = emailParam);
        const disp = document.getElementById('displayEmail');
        if (disp) disp.textContent = emailParam;
      }
    })();
  </script>
</body>
</html>
